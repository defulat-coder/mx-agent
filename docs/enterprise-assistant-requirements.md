# 马喜智能助手 — 企业级需求全景

## 一、系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                       客户端层                                │
│                (Web / 移动端 / 企业微信 / 钉钉)                │
└────────────────────────────┬────────────────────────────────┘
                             ▼
┌─────────────────────────────────────────────────────────────┐
│                      Router Team                            │
│               JWT 认证 → 角色识别 → 智能路由                   │
├──────┬──────┬──────┬──────┬──────┬──────┬───────────────────┤
│  HR  │  IT  │ 行政 │ 财务 │ 法务 │ 项目 │ 数据分析           │
│ Agent│ Agent│ Agent│ Agent│ Agent│ Agent│ Agent              │
├──────┴──────┴──────┴──────┴──────┴──────┴───────────────────┤
│                    共享基础设施                                │
│  权限体系 / Skills 知识库 / 脱敏日志 / 会话记忆 / 链路追踪     │
└─────────────────────────────────────────────────────────────┘
```

## 二、角色权限体系（全局统一）

| 角色 | 标识 | 数据范围 |
|------|------|----------|
| 员工 | employee | 本人数据 |
| 部门主管 | manager | 本部门数据（递归子部门） |
| 管理者 | admin | 全公司数据 |
| 人才发展 | talent_dev | 全公司人才数据 |
| IT 管理员 | it_admin | 全公司 IT 资产/工单 |
| 行政人员 | admin_staff | 全公司行政资源 |
| 财务人员 | finance | 全公司财务数据 |
| 法务人员 | legal | 全公司合同/合规数据 |
| 项目管理 | pm | 关联项目数据 |

---

## 三、业务域详细需求

### 1. HR 助手（✅ 已上线）

> 55 个 Tools + 8 个 Skills，覆盖员工/主管/管理者/人才发展四个角色。

| 模块 | 员工自助 | 主管 | 管理者 | 人才发展 |
|------|---------|------|--------|---------|
| 个人信息 | ✅ 查看自己 | ✅ 查看下属档案 | ✅ 查看任意员工 | ✅ 全维度画像 |
| 薪资 | ✅ 查看自己 | ❌ 无权 | ✅ 查看任意 | ✅ 查看任意 |
| 社保 | ✅ 查看自己 | ❌ 无权 | ✅ 查看任意 | ✅ 查看任意 |
| 考勤 | ✅ 查看自己 | ✅ 团队考勤 | ✅ 全公司 | ✅ 查看任意 |
| 请假 | ✅ 查看+申请 | ✅ 团队+审批 | ✅ 全公司+审批 | — |
| 加班 | ✅ 查看+登记 | ✅ 团队+审批 | ✅ 全公司+审批 | — |
| 报销 | ✅ 申请 | — | — | — |
| 培训 | — | — | — | ✅ 查看+统计 |
| 绩效 | — | ✅ 下属绩效 | — | ✅ 详情+分布 |
| 人才盘点 | — | — | — | ✅ 九宫格+高潜 |
| IDP | — | — | — | ✅ 查看+统计 |
| 人才发现 | — | — | — | ✅ 6 大场景 |
| 制度咨询 | ✅ 全员 | ✅ 全员 | ✅ 全员 | ✅ 全员 |

---

### 2. IT 运维助手（🔜 优先级高）

#### 2.1 用户角色与权限

| 角色 | 能力 |
|------|------|
| 员工 | 查看自己的工单/设备、提交工单、自助排查 |
| IT 管理员 | 查看全部工单、处理/关闭工单、设备管理、权限管理、统计报表 |

#### 2.2 功能清单

**员工自助**

| 功能 | 说明 | 工具类型 |
|------|------|---------|
| 账号密码重置 | 邮箱/AD/VPN 密码重置申请 | Action → 审批链接 |
| 软件安装申请 | 申请安装指定软件 | Action → 审批链接 |
| 设备报修 | 电脑/显示器/键鼠等故障报修 | Action → 生成工单 |
| 权限申请 | 系统权限/文件夹权限/群组权限 | Action → 审批链接 |
| 工单查询 | 查看自己的工单状态和进度 | Query |
| 我的设备 | 查看自己名下的 IT 设备 | Query |
| 常见问题排查 | WiFi/VPN/打印机/邮箱等自助排查 | Skills 知识库 |
| IT 制度咨询 | 设备使用规范、信息安全制度等 | Skills 知识库 |

**IT 管理员**

| 功能 | 说明 | 工具类型 |
|------|------|---------|
| 工单列表 | 按状态/类型/紧急度筛选全部工单 | Query |
| 工单处理 | 受理/处理/关闭/转派工单 | Action |
| 设备资产管理 | 查询设备分配、库存、报废情况 | Query |
| 批量权限管理 | 批量开通/回收系统权限 | Action |
| 设备分配 | 入职分配/离职回收设备 | Action |
| 工单统计 | 各类型工单数量、平均处理时长、满意度 | Query（报表） |
| 故障趋势分析 | 高频故障类型、部门分布 | Query（报表） |

#### 2.3 数据模型（预估）

| 模型 | 说明 |
|------|------|
| ITAsset | IT 设备资产（电脑/显示器/配件） |
| ITTicket | IT 工单（报修/申请/故障） |
| SoftwareRequest | 软件安装申请 |
| PermissionRequest | 权限申请 |
| ITKnowledge | IT 常见问题知识库 |

#### 2.4 Skills 知识库

| Skill | 描述 |
|-------|------|
| wifi-vpn | WiFi/VPN 连接问题排查 |
| printer | 打印机常见问题 |
| email | 邮箱配置和常见问题 |
| security | 信息安全制度和规范 |
| device-policy | 设备使用和管理规范 |

---

### 3. 行政助手（🔜 优先级高）

#### 3.1 用户角色与权限

| 角色 | 能力 |
|------|------|
| 员工 | 预订/查询会议室、申请办公用品、查询快递、差旅申请 |
| 行政人员 | 管理会议室、审批办公用品、管理快递、访客管理、统计报表 |

#### 3.2 功能清单

**员工自助**

| 功能 | 说明 | 工具类型 |
|------|------|---------|
| 会议室预订 | 查询空闲会议室并预订 | Query + Action |
| 会议室查询 | 查看自己的预订记录 | Query |
| 取消预订 | 取消自己的会议室预订 | Action |
| 办公用品申领 | 申请笔/本/耗材等 | Action → 审批 |
| 快递查询 | 查询自己的收发快递 | Query |
| 差旅申请 | 机票/酒店/行程申请 | Action → 审批链接 |
| 访客预约 | 预约外部访客来访 | Action |
| 行政制度咨询 | 差旅标准、报销标准、办公规范 | Skills 知识库 |

**行政人员**

| 功能 | 说明 | 工具类型 |
|------|------|---------|
| 会议室管理 | 查看全部预订、强制释放、设置维护 | Query + Action |
| 办公用品审批 | 审批申领、库存管理 | Action |
| 快递管理 | 登记到件、通知取件、统计 | Query + Action |
| 访客管理 | 访客登记、来访记录、黑名单 | Query + Action |
| 使用统计 | 会议室使用率、办公用品消耗、快递量统计 | Query（报表） |

#### 3.3 数据模型（预估）

| 模型 | 说明 |
|------|------|
| MeetingRoom | 会议室信息（容量/设备/楼层） |
| RoomBooking | 会议室预订记录 |
| OfficeSupply | 办公用品库存 |
| SupplyRequest | 办公用品申领记录 |
| Express | 快递收发记录 |
| Visitor | 访客登记记录 |
| TravelRequest | 差旅申请 |

---

### 4. 财务助手（✅ 已上线）

#### 4.1 用户角色与权限

| 角色 | 能力 |
|------|------|
| 员工 | 查看自己的报销单、发票验真、预算查询、财务制度咨询 |
| 部门预算负责人 | 部门预算余额、费用明细、预算预警 |
| 财务人员 | 报销审核、全公司费用汇总、预算执行分析、应收应付管理 |

#### 4.2 功能清单

**员工自助**

| 功能 | 说明 | 工具类型 |
|------|------|---------|
| 报销进度查询 | 查看自己的报销单状态 | Query |
| 发票验真 | 输入发票代码/号码验证真伪 | Action（调用税务接口） |
| 报销政策咨询 | 差旅标准、餐费限额、审批流程 | Skills 知识库 |
| 预算余额查询 | 查看所在部门/项目预算余额 | Query |
| 个税查询 | 查看个人所得税明细 | Query |

**部门预算负责人**

| 功能 | 说明 | 工具类型 |
|------|------|---------|
| 部门预算总览 | 预算总额/已用/余额/执行率 | Query |
| 费用明细 | 按科目/人员/时间查看费用 | Query |
| 预算预警 | 超支/即将超支提醒 | Query |

**财务人员**

| 功能 | 说明 | 工具类型 |
|------|------|---------|
| 报销审核 | 查看待审报销单、通过/拒绝/退回 | Query + Action |
| 费用汇总 | 各部门/科目/月度费用汇总 | Query（报表） |
| 预算执行分析 | 全公司预算执行率、偏差分析 | Query（报表） |
| 应收应付提醒 | 到期/逾期的应收应付款提醒 | Query |
| 开票申请处理 | 开票申请查看和处理 | Action |

#### 4.3 数据模型（预估）

| 模型 | 说明 |
|------|------|
| Reimbursement | 报销单（类型/金额/状态/审批） |
| ReimbursementItem | 报销明细行 |
| Invoice | 发票记录 |
| Budget | 部门/项目预算 |
| BudgetUsage | 预算使用记录 |
| Payable | 应付款 |
| Receivable | 应收款 |

#### 4.4 敏感数据

报销金额、预算金额、薪资关联数据均需脱敏处理，复用 `app/core/masking.py`。

---

### 5. 法务助手（✅ 已上线）

#### 5.1 用户角色与权限

| 角色 | 能力 |
|------|------|
| 员工 | 合同模板查询、法律咨询、合规培训查询 |
| 法务人员 | 合同管理、合规审查、风险预警、统计报表 |

#### 5.2 功能清单

**员工自助**

| 功能 | 说明 | 工具类型 |
|------|------|---------|
| 合同模板查询 | 按类型搜索合同模板 | Query |
| 合同模板下载 | 获取标准合同模板 | Action |
| 法律咨询 | 劳动法/竞业/保密/知识产权问答 | Skills 知识库 |
| 合同审批进度 | 查看自己提交的合同审批状态 | Query |
| 合规培训 | 合规培训材料和考试 | Skills 知识库 |

**法务人员**

| 功能 | 说明 | 工具类型 |
|------|------|---------|
| 合同台账 | 全公司合同列表（按类型/状态/到期日） | Query |
| 合同审查 | 待审合同列表、审查通过/退回 | Query + Action |
| 到期预警 | 即将到期的合同提醒 | Query |
| 合同条款分析 | 关键条款提取和风险提示 | Tool（LLM 辅助） |
| 诉讼/纠纷管理 | 案件跟踪、进度更新 | Query + Action |
| 统计报表 | 合同数量/金额/类型分布、风险统计 | Query（报表） |

#### 5.3 数据模型（预估）

| 模型 | 说明 |
|------|------|
| ContractTemplate | 合同模板 |
| Contract | 合同记录（类型/金额/期限/状态） |
| ContractReview | 合同审查记录 |
| LegalCase | 诉讼/纠纷案件 |
| ComplianceTraining | 合规培训记录 |

---

### 6. 项目管理助手（❌ 不实现）

#### 6.1 用户角色与权限

| 角色 | 能力 |
|------|------|
| 员工 | 查看自己的任务、更新进度、提交周报 |
| 项目经理 | 项目全局视图、任务分配、排期管理、风险跟踪 |
| 管理者 | 跨项目资源视图、项目健康度总览 |

#### 6.2 功能清单

**员工**

| 功能 | 说明 | 工具类型 |
|------|------|---------|
| 我的任务 | 查看待办/进行中/已完成任务 | Query |
| 更新进度 | 更新任务状态和完成度 | Action |
| 周报生成 | 基于本周任务自动生成周报草稿 | Tool（LLM 辅助） |
| 项目文档查询 | 查询项目相关文档和规范 | Skills 知识库 |

**项目经理**

| 功能 | 说明 | 工具类型 |
|------|------|---------|
| 项目总览 | 进度/里程碑/风险/资源 | Query |
| 任务分配 | 创建任务、分配给成员 | Action |
| 排期查询 | 甘特图视角的排期信息 | Query |
| 风险登记 | 登记/更新项目风险 | Action |
| 团队工时 | 成员工时投入统计 | Query（报表） |
| 站会摘要 | 基于成员更新生成站会摘要 | Tool（LLM 辅助） |

#### 6.3 数据模型（预估）

| 模型 | 说明 |
|------|------|
| Project | 项目信息 |
| Task | 任务（所属项目/负责人/状态/截止日） |
| Milestone | 里程碑 |
| Risk | 项目风险 |
| WeeklyReport | 周报 |
| TimeEntry | 工时记录 |

---

### 7. 数据分析助手（❌ 不实现）

#### 7.1 用户角色与权限

| 角色 | 能力 |
|------|------|
| 部门主管 | 本部门业务指标查询 |
| 管理者 | 全公司指标看板、趋势分析 |
| 数据分析师 | 自定义查询、报表生成 |

#### 7.2 功能清单

| 功能 | 说明 | 工具类型 |
|------|------|---------|
| 指标查询 | 自然语言查询业务指标（营收/人效/成本等） | Tool（Text2SQL） |
| 趋势分析 | 指标同比/环比/趋势 | Tool（LLM + SQL） |
| 报表生成 | 基于查询结果生成可视化报表 | Tool（LLM 辅助） |
| 异常预警 | 指标异常波动自动预警 | Query |
| 数据字典 | 查询表/字段含义和口径 | Skills 知识库 |

---

## 四、跨域协作场景

利用 Router Team 的多 Agent 路由能力，实现跨部门流程的一站式服务。

### 4.1 新员工入职

```
员工: "我是新入职的，需要办什么手续？"

Router → 依次协调：
  HR Agent    → 入职手续清单、签合同、录指纹
  IT Agent    → 开通账号、领电脑、配权限、装软件
  行政 Agent  → 领工卡、分配工位、领办公用品
  财务 Agent  → 开通报销账户、绑定银行卡
```

### 4.2 员工离职

```
HR Agent    → 离职流程、交接清单、离职证明
IT Agent    → 回收设备、注销账号、回收权限
行政 Agent  → 退还工卡、清理工位
财务 Agent  → 结算报销、薪资结算
```

### 4.3 出差全流程

```
行政 Agent  → 差旅申请、订机票/酒店
HR Agent    → 考勤登记（出差状态）
财务 Agent  → 差旅报销、发票验真
```

### 4.4 项目启动

```
项目 Agent  → 创建项目、分配任务
HR Agent    → 调配人员、评估团队能力（人才发现）
IT Agent    → 开通项目相关系统权限
财务 Agent  → 设置项目预算
```

---

## 五、技术复用策略

所有新 Agent 复用现有基础设施，仅新增业务模型和工具：

| 基础设施 | 状态 | 复用方式 |
|----------|------|---------|
| JWT 认证 + 角色注入 | ✅ 已有 | 扩展 roles 枚举 |
| Router Team 路由 | ✅ 已有 | members 列表添加新 Agent |
| SQLite + AsyncSession | ✅ 已有 | 新增业务表 |
| Skills 知识库 | ✅ 已有 | 新增 skills/{domain}/ 目录 |
| 脱敏日志 | ✅ 已有 | 复用 masking.py |
| Tool 权限校验 | ✅ 已有 | 复用 get_xxx_id() 模式 |
| 会话记忆 | ✅ 已有 | AgentOS SqliteDb |
| 链路追踪 | ✅ 已有 | OpenTelemetry |

每个新 Agent 的开发模式统一为：

```
1. 定义数据模型 → app/models/{domain}/
2. 定义 Schema  → app/schemas/{domain}.py
3. 实现 Service → app/services/{domain}.py
4. 实现 Tools   → app/tools/{domain}/
5. 编写 Skills  → app/skills/{domain}/
6. 注册 Agent   → app/agents/{domain}_agent.py
7. 挂载到 Router → app/agents/router_agent.py members 追加
```

---

## 六、建议实施路线

| 阶段 | 内容 | 周期 | 说明 |
|------|------|------|------|
| P0 | HR 助手完善 | ✅ 已完成 | 4 角色 55 工具 |
| P1 | IT 运维助手 | 2-3 周 | 高频刚需，数据结构简单 |
| P1 | 行政助手 | 2-3 周 | 高频刚需，可并行开发 |
| P2 | 财务助手 | 3-4 周 | 报销是高频，预算分析较复杂 |
| P2 | 法务助手 | 2-3 周 | 以知识库为主，合同管理进阶 |
| P3 | 项目管理助手 | 4-5 周 | 需对接项目管理工具或自建 |
| P3 | 数据分析助手 | 4-5 周 | 需 Text2SQL 能力，技术门槛高 |
| P4 | 跨域协作场景 | 2-3 周 | 基于已有 Agent 编排，无新数据模型 |
